<!DOCTYPE html>
<html lang="ko" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2025 호수 오픈 - 파트너 전적 & 랭킹</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700;900&family=Poppins:wght@600;700&display=stylesheet" rel="stylesheet">
    <style>
        :root {
            --bg-color: #121212; --surface-color: #1E1E1E; --primary-color: #4CAF50; --primary-variant-color: #81C784; --secondary-color: #FFFFFF; --text-color: #E0E0E0; --text-secondary-color: #A0A0A0; --accent-gold: #FFC107; --border-color: #333333; --shadow-color: rgba(0, 0, 0, 0.5);
            --spacing-sm: 8px; --spacing-md: 12px; --spacing-lg: 20px; --radius: 8px;
        }
        html[data-theme="light"] {
            --bg-color: #F0F4F8; --surface-color: #FFFFFF; --primary-color: #1A3C34; --primary-variant-color: #2A6B5B; --text-color: #1F2937; --text-secondary-color: #6B7280; --border-color: #E5E7EB; --shadow-color: rgba(0, 0, 0, 0.1);
        }
        body { font-family: 'Noto Sans KR', sans-serif; background-color: var(--bg-color); color: var(--text-color); margin: 0; padding: var(--spacing-md); transition: background-color 0.3s, color 0.3s; }
        .container { max-width: 1700px; margin: 0 auto; }
        h1 { font-family: 'Poppins', sans-serif; font-size: 2.8rem; font-weight: 900; text-align: center; color: var(--secondary-color); background: linear-gradient(135deg, var(--primary-color), var(--primary-variant-color)); -webkit-background-clip: text; background-clip: text; color: transparent; padding-top: var(--spacing-lg); margin-bottom: 2rem; letter-spacing: -2px; text-shadow: 2px 2px 10px var(--shadow-color); }
        .section { background: var(--surface-color); padding: var(--spacing-lg); border-radius: var(--radius); box-shadow: 0 10px 30px var(--shadow-color); margin-bottom: 2.5rem; border: 1px solid var(--border-color); }
        h2 { font-family: 'Poppins', sans-serif; font-size: 1.8rem; font-weight: 700; color: var(--primary-color); margin-bottom: var(--spacing-sm); padding-bottom: var(--spacing-sm); border-bottom: 2px solid var(--border-color); }
        .btn { display: inline-block; padding: var(--spacing-md) var(--spacing-lg); background: linear-gradient(135deg, var(--primary-color), var(--primary-variant-color)); color: #FFFFFF; text-decoration: none; border-radius: var(--radius); cursor: pointer; font-weight: 700; font-size: 1rem; border: none; text-align: center; }
        html[data-theme="dark"] .btn { color: var(--bg-color); }
        .btn.secondary { background: var(--surface-color); color: var(--text-color); border: 1px solid var(--border-color); }
        .table-wrapper { overflow-x: auto; max-width: 100%; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: var(--spacing-md); text-align: center; border-bottom: 1px solid var(--border-color); font-size: 0.9rem; white-space: nowrap; }
        thead th { position: sticky; top: 0; background: var(--surface-color); z-index: 10; cursor: pointer; }
        th { font-family: 'Poppins', sans-serif; background-color: rgba(0, 0, 0, 0.2); color: var(--primary-variant-color); font-weight: 700; }
        html[data-theme="light"] th { background-color: #F9FAFB; }
        .rank-cell { font-weight: 900; color: var(--accent-gold); }
        .win-rate { font-weight: bold; }
        .positive { color: #4CAF50; }
        .negative { color: #F44336; }
        .toast { position: fixed; bottom: var(--spacing-lg); left: 50%; transform: translateX(-50%); background: linear-gradient(135deg, #333, #111); color: #fff; padding: var(--spacing-md) 25px; border-radius: 50px; box-shadow: 0 5px 15px var(--shadow-color); opacity: 0; transition: opacity 0.4s, transform 0.4s; font-weight: 700; z-index: 1000; }
        .toast.show { opacity: 1; }
        .theme-toggle { position: fixed; top: 15px; right: 15px; background: var(--surface-color); border: 1px solid var(--border-color); border-radius: 50%; width: 40px; height: 40px; font-size: 1.5rem; cursor: pointer; color: var(--text-color); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .ranking-filter { display: flex; gap: var(--spacing-sm); margin-bottom: var(--spacing-lg); flex-wrap: wrap; }
        .filter-btn { padding: var(--spacing-sm) var(--spacing-md); background: var(--surface-color); border: 1px solid var(--border-color); border-radius: var(--radius); cursor: pointer; color: var(--text-color); font-weight: 700; }
        .filter-btn.active { background: var(--primary-color); color: var(--bg-color); }
        .input-group { display: flex; gap: var(--spacing-sm); margin-bottom: var(--spacing-lg); flex-wrap: wrap; align-items: center; }
        input[type="text"] { width: 100%; min-width: 150px; max-width: 250px; padding: var(--spacing-sm); background-color: var(--surface-color); border: 1px solid var(--border-color); border-radius: 6px; box-sizing: border-box; color: var(--text-color); font-family: 'Noto Sans KR', sans-serif; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: var(--spacing-sm); margin: var(--spacing-lg) 0; }
        .stat-box { background: rgba(0, 0, 0, 0.2); padding: var(--spacing-md); border-radius: var(--radius); text-align: center; }
        html[data-theme="light"] .stat-box { background: rgba(0, 0, 0, 0.05); }
        .stat-box h3 { font-size: 1rem; margin: 0 0 var(--spacing-sm); color: var(--primary-color); }
        .stat-box p { font-size: 1.5rem; font-weight: 700; margin: 0; color: var(--accent-gold); }
        #chemistry-table tbody tr { cursor: pointer; transition: background-color 0.2s; }
        #chemistry-table tbody tr:hover { background-color: rgba(255,255,255,0.05); }
        .season-tabs{display:flex;gap:10px;margin-bottom:20px;border-bottom:2px solid var(--border-color);padding-bottom:10px}
        .tab-btn{padding:10px 20px;font-size:1rem;font-weight:700;background:none;border:none;color:var(--text-secondary-color);cursor:pointer;border-bottom:3px solid transparent;transition:color .3s,border-color .3s}
        .tab-btn.active{color:var(--primary-color);border-bottom:3px solid var(--primary-color)}
        @media screen and (max-width: 600px) {
            h1 { font-size: 2rem; }
            th, td { font-size: 0.75rem; padding: var(--spacing-sm) 4px; }
            .stats-grid { grid-template-columns: repeat(3, 1fr); }
            .stat-box p { font-size: 1.1rem; }
            .tab-btn{padding:8px 10px;font-size:.9rem}
        }
    </style>
</head>
<body>
    <button class="theme-toggle" id="theme-toggle">☀️</button>
    <div class="container">
        <h1 id="main-title">파트너 전적 & 랭킹</h1>
        <div class="season-tabs">
            <button class="tab-btn active" data-view="current">2025-26 겨울시즌</button>
            <button class="tab-btn" data-view="previous">2025 여름시즌</button>
            <button class="tab-btn" data-view="alltime">통산 기록</button>
        </div>
        
        <div class="section">
            <h2>파트너 전적 검색</h2>
            <div class="input-group">
                <input type="text" id="player1" list="player-list" placeholder="선수 1 이름">
                <input type="text" id="player2" list="player-list" placeholder="선수 2 이름">
                <datalist id="player-list"></datalist>
                <button id="search-btn" class="btn">전적 검색</button>
                <button id="reset-btn" class="btn secondary">초기화</button>
            </div>
            <div id="search-results-container" style="display: none;">
                <div class="stats-grid" id="stats-grid"></div>
                <div class="table-wrapper">
                    <table id="partner-table">
                        <thead>
                            <tr><th>회차</th><th>결과</th><th>상대팀</th><th>스코어</th><th>득실차</th></tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>최고의 케미 랭킹 (최소 5경기)</h2>
            <div class="ranking-filter">
                <button class="filter-btn active" data-filter="all">통합</button>
                <button class="filter-btn" data-filter="male">남자복식</button>
                <button class="filter-btn" data-filter="female">여자복식</button>
                <button class="filter-btn" data-filter="mixed">혼합복식</button>
            </div>
            <div class="table-wrapper">
                <table id="chemistry-table">
                    <thead>
                        <tr>
                            <th data-sort="rank">순위</th>
                            <th data-sort="pair">파트너</th>
                            <th data-sort="chemistryScore">케미 점수</th>
                            <th data-sort="matches">경기수</th>
                            <th data-sort="wins">승</th>
                            <th data-sort="losses">패</th>
                            <th data-sort="winRate">승률(%)</th>
                            <th data-sort="avgGameDiff">평균 득실</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td colspan="8">데이터를 불러오는 중입니다...</td></tr>
                    </tbody>
                </table>
            </div>
             <a href="index.html" class="btn" id="main-link" style="margin-top: 20px;">메인으로 돌아가기</a>
        </div>
    </div>
    <div id="toast" class="toast"></div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";
    import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAlcszFYMqJjaJQHajx7K695zoeRS7PsxU",
        authDomain: "tennis-plan-jibung.firebaseapp.com",
        projectId: "tennis-plan-jibung",
        storageBucket: "tennis-plan-jibung.appspot.com",
        messagingSenderId: "491083537160",
        appId: "1:491083537160:web:0c2ec53b1285aa1cdc6abd"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const BASE_COLLECTION = 'league';
    const SEASONS = {
        'v2': { name: '2025-26 겨울시즌' },
        'v1': { name: '2025 여름시즌' },
    };
    const CURRENT_SEASON_VERSION = 'v2';
    const PREVIOUS_SEASON_VERSION = 'v1';

    let sortKey = 'chemistryScore', sortOrder = 'desc';
    let currentFilter = 'all';
    let activeView = 'current';
    let allPairStats = [];
    let allMatches = [];
    const playerGenderMap = new Map();

    function showToast(message) {
        const toast = document.getElementById('toast');
        if(toast) {
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }
    }

    function normalizeName(name) {
        return name ? name.replace(/[@.*\s]+/g, '').toLowerCase() : '';
    }
    
    function cleanName(name) {
        return name ? name.replace(/\*/g, '').trim() : '';
    }

    async function loadDataForView() {
        showToast('데이터를 불러오는 중입니다...');
        let scheduleDocs = [];
        let rankingDocs = [];

        if (activeView === 'current') {
            scheduleDocs.push(getDoc(doc(db, BASE_COLLECTION, 'data', 'schedule', CURRENT_SEASON_VERSION)));
            rankingDocs.push(getDoc(doc(db, BASE_COLLECTION, 'data', 'rankings', CURRENT_SEASON_VERSION)));
        } else if (activeView === 'previous') {
            scheduleDocs.push(getDoc(doc(db, BASE_COLLECTION, 'data', 'schedule', PREVIOUS_SEASON_VERSION)));
            rankingDocs.push(getDoc(doc(db, BASE_COLLECTION, 'data', 'rankings', PREVIOUS_SEASON_VERSION)));
        } else { // alltime
            scheduleDocs.push(getDoc(doc(db, BASE_COLLECTION, 'data', 'schedule', PREVIOUS_SEASON_VERSION)));
            scheduleDocs.push(getDoc(doc(db, BASE_COLLECTION, 'data', 'schedule', CURRENT_SEASON_VERSION)));
            rankingDocs.push(getDoc(doc(db, BASE_COLLECTION, 'data', 'rankings', PREVIOUS_SEASON_VERSION)));
            rankingDocs.push(getDoc(doc(db, BASE_COLLECTION, 'data', 'rankings', CURRENT_SEASON_VERSION)));
        }

        try {
            const scheduleSnaps = await Promise.all(scheduleDocs);
            const rankingSnaps = await Promise.all(rankingDocs);
            
            allMatches = scheduleSnaps.flatMap(snap => snap.exists() ? snap.data().matches : []);
            
            playerGenderMap.clear();
            const allPlayers = new Map();
            rankingSnaps.forEach(snap => {
                if (snap.exists()) {
                    (snap.data().players || []).forEach(p => {
                        allPlayers.set(cleanName(p.name), p);
                    });
                }
            });

            const playerList = document.getElementById('player-list');
            playerList.innerHTML = '';
            [...allPlayers.values()].sort((a,b) => a.name.localeCompare(b.name, 'ko')).forEach(p => {
                const cleanPlayerName = cleanName(p.name);
                playerGenderMap.set(normalizeName(p.name), p.isFemale);
                const option = document.createElement('option');
                option.value = cleanPlayerName;
                playerList.appendChild(option);
            });

            calculateAllPairStats();
            displayRankings();

        } catch (e) {
            console.error("데이터 로드 실패:", e);
            showToast("데이터 로드에 실패했습니다.");
        }
    }

    function calculateAllPairStats() {
        const partnerStats = {};

        function getPairType(pair) {
            const isFemale1 = playerGenderMap.get(normalizeName(pair[0])) || false;
            const isFemale2 = playerGenderMap.get(normalizeName(pair[1])) || false;
            if (isFemale1 && isFemale2) return 'female';
            if (!isFemale1 && !isFemale2) return 'male';
            return 'mixed';
        }

        function updatePairStats(pair, isWinner, gameDiff) {
            if (pair.some(p => !p)) return;
            const pairKey = pair.sort().join(' & ');
            if (!partnerStats[pairKey]) {
                partnerStats[pairKey] = { 
                    wins: 0, losses: 0, matches: 0, totalGameDiff: 0, 
                    pair: pair.join(' & '),
                    type: getPairType(pair)
                };
            }
            const stats = partnerStats[pairKey];
            stats.matches++;
            stats.totalGameDiff += gameDiff;
            if (isWinner) stats.wins++;
            else stats.losses++;
        }

        allMatches.forEach(match => {
            if (!match.score || !/^\d+-\d+$/.test(match.score)) return;
            const [score1, score2] = match.score.split('-').map(Number);
            const team1 = [cleanName(match.players[0]), cleanName(match.players[1])];
            const team2 = [cleanName(match.players[2]), cleanName(match.players[3])];
            const gameDiff = score1 - score2;
            updatePairStats(team1, score1 > score2, gameDiff);
            updatePairStats(team2, score2 > score1, -gameDiff);
        });

        allPairStats = Object.values(partnerStats)
            .filter(stats => stats.matches >= 5)
            .map(stats => {
                const winRate = stats.matches > 0 ? (stats.wins / stats.matches) * 100 : 0;
                const avgGameDiff = stats.matches > 0 ? stats.totalGameDiff / stats.matches : 0;
                const chemistryScore = (winRate * 10) + avgGameDiff;
                return { ...stats, winRate, avgGameDiff, chemistryScore };
            });
    }
    
    function displayRankings() {
        let filteredRankings = allPairStats;
        if (currentFilter !== 'all') {
            filteredRankings = allPairStats.filter(stats => stats.type === currentFilter);
        }
        renderRankingTable(filteredRankings);
    }

    function renderRankingTable(rankings) {
        rankings.sort((a, b) => {
            let compare;
            if (sortKey === 'pair') {
                compare = a.pair.localeCompare(b.pair);
            } else {
                compare = (b[sortKey] || 0) - (a[sortKey] || 0);
            }
            return sortOrder === 'asc' ? -compare : compare;
        });

        const tableBody = document.querySelector('#chemistry-table tbody');
        tableBody.innerHTML = '';

        if (rankings.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="8">조건에 맞는 파트너 조합이 없습니다. (최소 5경기)</td></tr>`;
            return;
        }

        rankings.forEach((stats, index) => {
            const row = tableBody.insertRow();
            row.dataset.pair = stats.pair;
            row.innerHTML = `
                <td class="rank-cell">${index + 1}</td>
                <td>${stats.pair}</td>
                <td>${stats.chemistryScore.toFixed(2)}</td>
                <td>${stats.matches}</td>
                <td>${stats.wins}</td>
                <td>${stats.losses}</td>
                <td class="win-rate">${stats.winRate.toFixed(1)}%</td>
                <td class="${stats.avgGameDiff > 0 ? 'positive' : 'negative'}">${stats.avgGameDiff > 0 ? '+' : ''}${stats.avgGameDiff.toFixed(2)}</td>
            `;
        });
    }

    function handleSearch() {
        const player1Input = document.getElementById('player1').value.trim();
        const player2Input = document.getElementById('player2').value.trim();
        if (!player1Input || !player2Input) {
            showToast("두 선수를 모두 입력하세요!");
            return;
        }

        const normP1 = normalizeName(player1Input);
        const normP2 = normalizeName(player2Input);
        if (normP1 === normP2) {
            showToast("동일한 선수를 선택할 수 없습니다!");
            return;
        }

        const filteredMatches = allMatches.filter(match => {
            const normalizedPlayers = match.players.map(p => normalizeName(p));
            const p1Index = normalizedPlayers.indexOf(normP1);
            const p2Index = normalizedPlayers.indexOf(normP2);
            if (p1Index === -1 || p2Index === -1) return false;
            return Math.floor(p1Index / 2) === Math.floor(p2Index / 2);
        });
        
        const resultsContainer = document.getElementById('search-results-container');
        const statsGrid = document.getElementById('stats-grid');
        const tableBody = document.querySelector('#partner-table tbody');
        
        tableBody.innerHTML = '';
        statsGrid.innerHTML = '';

        if (filteredMatches.length === 0) {
            showToast("선택한 파트너 간의 전적이 없습니다!");
            resultsContainer.style.display = 'none';
            return;
        }

        let wins = 0, losses = 0, totalGameDiff = 0;
        filteredMatches.forEach(match => {
            const p1Index = match.players.findIndex(p => normalizeName(p) === normP1);
            const isTeam1 = p1Index < 2;
            const [score1, score2] = match.score.split('-').map(Number);
            const isWinner = isTeam1 ? score1 > score2 : score2 > score1;
            const gameDiff = isTeam1 ? score1 - score2 : score2 - score1;
            
            if (isWinner) wins++; else losses++;
            totalGameDiff += gameDiff;

            const opponentTeam = isTeam1 ? `${cleanName(match.players[2])} & ${cleanName(match.players[3])}` : `${cleanName(match.players[0])} & ${cleanName(match.players[1])}`;
            
            const row = tableBody.insertRow();
            row.innerHTML = `
                <td>${match.round}</td>
                <td>${isWinner ? '✅' : '❌'}</td>
                <td>${opponentTeam}</td>
                <td>${match.score}</td>
                <td class="${gameDiff > 0 ? 'positive' : 'negative'}">${gameDiff > 0 ? '+' : ''}${gameDiff}</td>
            `;
        });

        const totalMatches = wins + losses;
        const winRate = totalMatches > 0 ? ((wins / totalMatches) * 100).toFixed(1) : '0.0';
        const avgGameDiff = totalMatches > 0 ? (totalGameDiff / totalMatches).toFixed(2) : '0.00';
        statsGrid.innerHTML = `
            <div class="stat-box"><h3>총 경기</h3><p>${totalMatches}</p></div>
            <div class="stat-box"><h3>승</h3><p>${wins}</p></div>
            <div class="stat-box"><h3>패</h3><p>${losses}</p></div>
            <div class="stat-box"><h3>승률(%)</h3><p>${winRate}</p></div>
            <div class="stat-box"><h3>평균 득실</h3><p>${avgGameDiff > 0 ? '+' : ''}${avgGameDiff}</p></div>
        `;
        resultsContainer.style.display = 'block';
        showToast("파트너 전적 검색 완료!");
    }

    function applyTheme(theme) {
        document.documentElement.setAttribute('data-theme', theme);
        const themeToggle = document.getElementById('theme-toggle');
        themeToggle.textContent = theme === 'dark' ? '☀️' : '🌙';
        localStorage.setItem('theme', theme);
    }

    document.addEventListener('DOMContentLoaded', async () => {
        applyTheme(localStorage.getItem('theme') || 'dark');
        
        try {
            await signInAnonymously(auth);
            await loadDataForView();
        } catch(e) {
            console.error("Auth or data load failed", e);
            showToast("데이터 로딩 중 오류 발생");
        }

        // --- Event Listeners ---
        document.getElementById('search-btn').addEventListener('click', handleSearch);
        
        document.getElementById('reset-btn').addEventListener('click', () => {
            document.getElementById('player1').value = '';
            document.getElementById('player2').value = '';
            document.getElementById('search-results-container').style.display = 'none';
        });

        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelector('.filter-btn.active').classList.remove('active');
                btn.classList.add('active');
                currentFilter = btn.dataset.filter;
                displayRankings();
            });
        });

        document.querySelectorAll('#chemistry-table thead th').forEach(th => {
            th.addEventListener('click', () => {
                const newSortKey = th.dataset.sort;
                if (!newSortKey) return;
                sortOrder = (sortKey === newSortKey && sortOrder === 'desc') ? 'asc' : 'desc';
                sortKey = newSortKey;
                displayRankings();
            });
        });

        document.querySelector('#chemistry-table tbody').addEventListener('click', (e) => {
            const row = e.target.closest('tr');
            if (!row || !row.dataset.pair) return;

            const [p1, p2] = row.dataset.pair.split(' & ');
            document.getElementById('player1').value = p1.trim();
            document.getElementById('player2').value = p2.trim();
            handleSearch();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });

        document.getElementById('theme-toggle').addEventListener('click', () => 
            applyTheme(document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark')
        );

        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelector('.tab-btn.active').classList.remove('active');
                btn.classList.add('active');
                activeView = btn.dataset.view;
                loadDataForView();
            });
        });
    });
</script>
</body>
</html>
